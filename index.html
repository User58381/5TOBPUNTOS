<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tabla de Puntos</title>
<style>
  body{
    font-family:"Comic Sans MS","Comic Sans","Comic Neue",cursive;
    background:#fff;
    color:#111;
    margin:0;
    text-align:center;
  }
  h1{margin:18px 0 6px;font-size:32px}
  #fecha{
    margin:16px auto 10px;
    padding:8px 12px;
    border:1px solid #e5e5e5;
    border-radius:10px;
    background:#f7f7f7;
    font-weight:bold;
  }
  .controls{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin:8px 0;
  }
  .controls input{
    padding:8px 10px;
    border:1px solid #d0d0d0;
    border-radius:8px;
  }
  .toggle{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border:1px solid #e0e0e0;
    border-radius:999px;
    background:#fafafa;
  }
  #status{font-size:14px;color:#666;margin:6px 0 12px}
  table{
    width:96%;
    max-width:1200px;
    margin:auto;
    border-collapse:collapse;
    border:1px solid #e0e0e0;
    background:#fff;
  }
  th,td{
    border:1px solid #d6d6d6;
    padding:10px;
    text-align:center;
  }
  thead th{
    background:gold;
    position:sticky;
    top:0;
  }
</style>
</head>
<body>
  <h1>Tabla de Puntos</h1>
  <div id="fecha"></div>
  <div class="controls">
    <input type="date" id="filtroFecha" onchange="render()"/>
    <input type="text" id="buscador" placeholder="Buscar alumno..." onkeyup="filtrarTabla()"/>
    <label class="toggle"><input type="checkbox" id="mostrarTodos" onchange="render()"/>Mostrar todos (incluye sin puntos)</label>
  </div>
  <div id="status">Cargando datos‚Ä¶</div>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Alumno</th>
        <th>Asistencia</th>
        <th>Puntos</th>
        <th>Trabaj√≥</th>
        <th>Rango</th>
        <th>Recompensas</th>
      </tr>
    </thead>
    <tbody id="tablaPuntos">
      <tr><td colspan="7">Cargando‚Ä¶</td></tr>
    </tbody>
  </table>

<script>
/* === CONFIGURACI√ìN DE HOJAS === */
const SHEET_ID         = "19godSKA4Yx9vNHrZpz6ReDeQFovMzlN7X0y6QX-BA6";
const GID_PUNTOS       = "0";           // Hoja PUNTOS
const GID_ASISTENCIA   = "1131375842";  // Hoja ASISTENCIA
const GID_TRABAJOS     = "1025312588";  // Registro de trabajos (por ahora no se usa aqu√≠)
const GID_PRESETS      = "495888198";   // Presets (por ahora no se usa aqu√≠)

/* === UTILIDADES B√ÅSICAS === */
function setStatus(t){
  const el=document.getElementById("status");
  if(el) el.textContent=t;
  console.log("[STATUS]",t);
}
function hoyISO(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function actualizarCabecera(){
  document.getElementById("fecha").innerHTML =
    `üìÖ Hoy es: <b>${new Date().toLocaleDateString('es-ES',{
      weekday:'long',year:'numeric',month:'long',day:'numeric'
    })}</b>`;
}

/* === RANGOS Y RECOMPENSAS === */
function obtenerRango(p){
  if(p>=90)return"üåàüî• Gran maestro arcoiris";
  if(p>=80)return"üåà Heroico arcoiris";
  if(p>=70)return"üü†üî• Heroico √©lite";
  if(p>=60)return"üü° Heroico";
  if(p>=50)return"üî¥ Gran Maestro";
  if(p>=40)return"üü† Maestro";
  if(p>=30)return"üü£ Experto";
  if(p>=20)return"üîµ Avanzado";
  if(p>=10)return"üü¢ Trabajador";
  return"‚ö™ Sin rango";
}
function obtenerRecompensas(p){
  const G=Math.floor(p/30), S=Math.floor((p%30)/10);
  let r="‚ú®";
  for(let i=0;i<G;i++)r+="üåü";
  for(let i=0;i<S;i++)r+="‚≠ê";
  if(p>=70)r+=" üåå";
  if(p>=90)r+=" üåà";
  return r;
}

/* === BUSCADOR EN TABLA === */
function filtrarTabla(){
  const f=document.getElementById("filtroFecha").value;
  const n=(document.getElementById("buscador").value||"").toLowerCase().trim();
  document.querySelectorAll("#tablaPuntos tr").forEach(tr=>{
    const F=tr.cells[0]?.innerText||"";
    const N=(tr.cells[1]?.innerText||"").toLowerCase();
    tr.style.display=(!f||F===f) && (!n||N.includes(n)) ? "" : "none";
  });
}

/* === PARSEO EXTREMO DE FECHAS A ISO (YYYY-MM-DD) === */
function headerToISO(h){
  if(h===null||h===undefined) return null;
  h=String(h).trim();
  if(!h) return null;

  // 1) Formato GViz tipo Date(2025,11,4)
  let m = h.match(/Date\(\s*(\d{4})\s*,\s*(\d{1,2})\s*,\s*(\d{1,2})\s*\)/i);
  if(m){
    let Y=parseInt(m[1],10);
    let M=parseInt(m[2],10)+1; // en JS enero=0
    let D=parseInt(m[3],10);
    return `${Y}-${String(M).padStart(2,"0")}-${String(D).padStart(2,"0")}`;
  }

  // 2) Formatos num√©ricos tipo:
  //    2025-12-04, 2025/12/4, 04/12/2025, 4-12-25, 2025.12.04, etc.
  m = h.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/); // YYYY-MM-DD
  if(m){
    const Y=m[1], M=m[2], D=m[3];
    return `${Y}-${String(M).padStart(2,"0")}-${String(D).padStart(2,"0")}`;
  }
  m = h.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/); // DD-MM-YY(YY)
  if(m){
    let D=m[1], M=m[2], Y=m[3];
    if(Y.length===2) Y=`20${Y}`;
    return `${Y}-${String(M).padStart(2,"0")}-${String(D).padStart(2,"0")}`;
  }

  // 3) Quitar hora tipo "2025-12-04 10:30:00"
  m = h.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})\s+\d{1,2}:\d{1,2}(:\d{1,2})?$/);
  if(m){
    const Y=m[1], M=m[2], D=m[3];
    return `${Y}-${String(M).padStart(2,"0")}-${String(D).padStart(2,"0")}`;
  }

  // 4) Meses en texto en espa√±ol, ej:
  //    "4 de diciembre de 2025"
  //    "jueves 4 de dic 2025"
  //    "diciembre 4, 2025"
  let txt = h.toLowerCase();
  txt = txt.normalize("NFD").replace(/[\u0300-\u036f]/g,""); // quitar acentos

  const meses = {
    "enero":1,"ene":1,
    "febrero":2,"feb":2,
    "marzo":3,"mar":3,
    "abril":4,"abr":4,
    "mayo":5,"may":5,
    "junio":6,"jun":6,
    "julio":7,"jul":7,
    "agosto":8,"ago":8,
    "septiembre":9,"setiembre":9,"sep":9,"set":9,
    "octubre":10,"oct":10,
    "noviembre":11,"nov":11,
    "diciembre":12,"dic":12
  };

  // Eliminar d√≠a de la semana al inicio si existe
  txt = txt.replace(/^(lunes|martes|miercoles|mi√©rcoles|jueves|viernes|sabado|s√°bado|domingo)\s*,?\s*/,"");

  // "4 de diciembre de 2025"
  m = txt.match(/^(\d{1,2})\s*de\s*([a-z√±]+)\s*de\s*(\d{4})$/);
  if(m){
    let D=parseInt(m[1],10);
    let M=meses[m[2]]||0;
    let Y=parseInt(m[3],10);
    if(M>=1&&M<=12){
      return `${Y}-${String(M).padStart(2,"0")}-${String(D).padStart(2,"0")}`;
    }
  }

  // "4 dic 2025"
  m = txt.match(/^(\d{1,2})\s+([a-z√±]+)\s+(\d{4})$/);
  if(m){
    let D=parseInt(m[1],10);
    let M=meses[m[2]]||0;
    let Y=parseInt(m[3],10);
    if(M>=1&&M<=12){
      return `${Y}-${String(M).padStart(2,"0")}-${String(D).padStart(2,"0")}`;
    }
  }

  // "diciembre 4 2025" o "dic 4 2025"
  m = txt.match(/^([a-z√±]+)\s+(\d{1,2})\s+(\d{4})$/);
  if(m){
    let M=meses[m[1]]||0;
    let D=parseInt(m[2],10);
    let Y=parseInt(m[3],10);
    if(M>=1&&M<=12){
      return `${Y}-${String(M).padStart(2,"0")}-${String(D).padStart(2,"0")}`;
    }
  }

  return null;
}

/* === HELPERS PARA CELDAS === */
function getCell(row,idx){
  const c=row.c?.[idx];
  if(!c) return "";
  const base = (c.f ?? c.v ?? "").toString();
  return base.trim();
}
function getCellRaw(row,idx){
  const c=row.c?.[idx];
  return c ? c.v : null;
}

/* === DETECCI√ìN DE FILA DE ENCABEZADO === */
function detectHeaderRow(data){
  const rows=data.table?.rows||[], cols=data.table?.cols||[];
  if(!rows.length) return {headerRowIdx:-1, labelsFrom:"cols"};

  const colLabels=cols.map(c=>(c.label||"").trim());
  const hasAnyLabel=colLabels.some(l=>l);

  const checkRowAsHeader = (r)=>{
    if(!r) return false;
    const c0=(getCell(r,0)||"").toLowerCase();
    let fechaCount=0;
    for(let i=0;i<cols.length;i++){
      const v=getCell(r,i);
      const raw=getCellRaw(r,i);
      const iso =
        headerToISO(v) ||
        (typeof raw==="number" && (data.table.cols[i]?.pattern||"").includes("yyyy") ? getCell(r,i) : null) ||
        (typeof raw==="string" && raw.startsWith("Date(") ? getCell(r,i) : null);
      if(iso) fechaCount++;
    }
    return c0.includes("nombre") || fechaCount>=2;
  };

  if(checkRowAsHeader(rows[0])) return {headerRowIdx:0, labelsFrom:"row"};
  if(hasAnyLabel) return {headerRowIdx:-1, labelsFrom:"cols"};
  if(rows.length>1 && checkRowAsHeader(rows[1])) return {headerRowIdx:1, labelsFrom:"row"};
  return {headerRowIdx:-1, labelsFrom:"cols"};
}

/* === DETECCI√ìN GEN√âRICA DE ESTRUCTURA === */
function detectarEstructura(data){
  const rows=data.table?.rows||[], cols=data.table?.cols||[];
  const {headerRowIdx, labelsFrom}=detectHeaderRow(data);

  let labels=[], dataStart=0;
  if(labelsFrom==="row" && headerRowIdx>=0){
    labels = cols.map((_,i)=> getCell(rows[headerRowIdx], i));
    dataStart = headerRowIdx+1;
  }else{
    labels = cols.map(c=>(c.label||"").toString().trim());
    dataStart = 0;
  }

  let idxNombre = labels.findIndex(h=>/^nombre del alumno$/i.test(h||""));
  if(idxNombre===-1) idxNombre = labels.findIndex(h=>/(^|\s)(nombre|alumno|estudiante)(\s|$)/i.test(h||""));
  if(idxNombre===-1) idxNombre = 0;

  const dateCols=[];
  for(let i=0;i<cols.length;i++){
    let iso = headerToISO(labels[i]||"");
    if(!iso && labelsFrom==="row" && headerRowIdx>=0){
      const vHead = getCell(rows[headerRowIdx], i);
      const rawHead= getCellRaw(rows[headerRowIdx], i);
      iso = headerToISO(vHead);
      if(!iso){
        const pat = (data.table.cols[i]?.pattern||"");
        if(typeof rawHead==="number" && pat.includes("yyyy")) iso = getCell(rows[headerRowIdx], i);
        if(typeof rawHead==="string" && rawHead.startsWith("Date(")){
          const f = getCell(rows[headerRowIdx], i);
          iso = headerToISO(f)||f;
        }
      }
    }
    if(iso) dateCols.push({i, iso});
  }

  return { idxNombre, dateCols, dataStart };
}

/* === ESTADO GLOBAL === */
let STATE={
  rows:[],
  idxNombre:0,
  dateCols:[],
  activeDate:null
};

// asistencia[fechaISO] = Set(canonicalName)
let ASISTENCIA_MAP = {};

function canonicalName(name){
  return name
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ")
    .trim();
}

/* === MAPEO DE ASISTENCIA === */
function buildAsistenciaMap(data){
  const rows=data.table?.rows||[];
  const det=detectarEstructura(data);
  const map={};

  for(const dc of det.dateCols){
    const fechaISO = dc.iso;
    const presentes = new Set();
    for(let rIndex=det.dataStart; rIndex<rows.length; rIndex++){
      const r=rows[rIndex];
      const nombre = getCell(r, det.idxNombre)||"";
      if(!nombre) continue;
      const c = r.c?.[dc.i];
      const raw = c ? (c.v ?? c.f ?? "") : "";
      const s = String(raw).trim();
      const num = parseInt(s.replace(/[^\d-]/g,""),10);
      const esUno = (!Number.isNaN(num) && num===1) || s==="1";
      if(esUno){
        presentes.add(canonicalName(nombre));
      }
    }
    map[fechaISO]=presentes;
  }
  return map;
}

/* === ELECCI√ìN DE FECHA ACTIVA (RESPETA HOY, NO MUESTRA FUTURO POR DEFECTO) === */
function elegirFechaActiva(){
  const input=document.getElementById("filtroFecha");
  const want=input.value;
  const today=hoyISO();

  if(want){
    const hit=STATE.dateCols.find(dc=>dc.iso===want);
    if(hit){
      STATE.activeDate=want;
      return;
    }
  }

  if(STATE.dateCols.length){
    const allDates=STATE.dateCols.map(dc=>dc.iso).sort();
    // Solo fechas <= hoy para no mostrar trabajos de futuro por defecto
    const pastOrToday = allDates.filter(d=>d<=today);
    const toUse = pastOrToday.length ? pastOrToday.at(-1) : allDates.at(-1);
    STATE.activeDate=toUse;
    input.value=toUse;
    return;
  }

  STATE.activeDate="";
  input.value="";
}

/* === RENDER TABLA === */
function render(){
  const tbody=document.getElementById("tablaPuntos");
  tbody.innerHTML="";

  if(!STATE.rows.length){
    tbody.innerHTML=`<tr><td colspan="7">No hay datos</td></tr>`;
    return;
  }

  elegirFechaActiva();
  if(!STATE.activeDate){
    tbody.innerHTML=`<tr><td colspan="7">No hay columnas de fecha v√°lidas</td></tr>`;
    return;
  }

  const target=STATE.dateCols.find(dc=>dc.iso===STATE.activeDate);
  if(!target){
    tbody.innerHTML=`<tr><td colspan="7">No se encontr√≥ la fecha seleccionada</td></tr>`;
    return;
  }

  const idxFechaCol=target.i;
  const showAll=document.getElementById("mostrarTodos")?.checked;
  const presentesSet = ASISTENCIA_MAP[STATE.activeDate] || null;

  const items=[];
  let totalAsisten=0;
  let totalTrabajan=0;

  for(const r of STATE.rows){
    const nombre = getCell(r, STATE.idxNombre)||"Alumno";
    if(!nombre) continue;
    const canon = canonicalName(nombre);

    const attended = !presentesSet || presentesSet.has(canon);
    if(!attended) continue; // solo quienes asistieron

    let puntos = parseInt(String(getCell(r, idxFechaCol)).replace(/[^\d-]/g,""),10);
    if(Number.isNaN(puntos)) puntos=0;

    if(puntos>0 || showAll){
      items.push({nombre,puntos,attended});
      totalAsisten++;
      if(puntos>0) totalTrabajan++;
    }
  }

  items.sort((a,b)=> b.puntos-a.puntos || a.nombre.localeCompare(b.nombre));

  if(!items.length){
    tbody.innerHTML=`<tr><td colspan="7">No hay alumnos con asistencia/puntos para ${STATE.activeDate}</td></tr>`;
    setStatus(`Sin registros para ${STATE.activeDate}.`);
    return;
  }

  for(const {nombre,puntos,attended} of items){
    const txtAsistencia = attended ? "‚úÖ S√≠" : "‚ùå No";
    const txtTrabajo    = puntos>0  ? "‚úÖ S√≠" : "‚ùå No";

    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${STATE.activeDate}</td>
        <td>${nombre}</td>
        <td>${txtAsistencia}</td>
        <td>${puntos}</td>
        <td>${txtTrabajo}</td>
        <td>${obtenerRango(puntos)}</td>
        <td>${obtenerRecompensas(puntos)}</td>
      </tr>
    `);
  }

  setStatus(`Asistieron ${totalAsisten} alumnos. De ellos, ${totalTrabajan} trabajaron (tienen puntos &gt; 0).`);
  filtrarTabla();
}

/* === CSV HELPERS (PUNTOS / ASISTENCIA) === */
function parseCSVtoGVizLike(csv){
  const rows=csv.split(/\r?\n/).filter(Boolean).map(r=>{
    const out=[];
    let cur="",q=false;
    for(let i=0;i<r.length;i++){
      const ch=r[i],nx=r[i+1];
      if(ch=='"'&&nx=='"'){cur+='"';i++;continue}
      if(ch=='"'){q=!q;continue}
      if(ch==','&&!q){out.push(cur);cur="";continue}
      cur+=ch;
    }
    out.push(cur);
    return out;
  });
  if(!rows.length) return {table:{cols:[],rows:[]}};
  const cols=rows[0];
  const data=rows.slice(1).map(r=>({ c: cols.map((_,i)=>({ v:r[i]??"" })) }));
  return {table:{ cols: cols.map(h=>({label:h})), rows:data }};
}

/* === GViz JSONP gen√©rico PUNTOS (gid) === */
function fetchGVizJSONP_Puntos(){
  return new Promise((resolve,reject)=>{
    const tq=encodeURIComponent('select *');
    const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID_PUNTOS}&tqx=out:json&tq=${tq}`;
    window.google=window.google||{};
    window.google.visualization=window.google.visualization||{};
    const old=window.google.visualization.Query?.setResponse;
    window.google.visualization.Query=window.google.visualization.Query||{};
    window.google.visualization.Query.setResponse=function(obj){
      try{
        if(obj.status && obj.status.toLowerCase()!=='ok'){
          const e=obj.errors?.[0]?.detailed_message||obj.errors?.[0]?.message||obj.status;
          reject(new Error("GViz error (Puntos): "+e));
        } else {
          resolve(obj);
        }
      } finally {
        if(old) window.google.visualization.Query.setResponse=old;
      }
    };
    const s=document.createElement("script");
    s.src=url;
    s.async=true;
    s.onerror=()=>{
      if(old) window.google.visualization.Query.setResponse=old;
      reject(new Error("GViz JSONP Puntos onerror (¬øpermisos?)"));
    };
    document.head.appendChild(s);
    setTimeout(()=>{
      if(window.google.visualization.Query.setResponse===old) return;
      window.google.visualization.Query.setResponse=old;
      reject(new Error("GViz JSONP Puntos timeout"));
    },8000);
  });
}

/* === GViz JSONP ASISTENCIA (por gid) + fallbacks CSV === */
function fetchGVizJSONP_Asistencia(){
  return new Promise((resolve,reject)=>{
    const tq=encodeURIComponent('select *');
    const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID_ASISTENCIA}&headers=1&tqx=out:json&tq=${tq}`;
    window.google=window.google||{};
    window.google.visualization=window.google.visualization||{};
    const old=window.google.visualization.Query?.setResponse;
    window.google.visualization.Query=window.google.visualization.Query||{};
    window.google.visualization.Query.setResponse=function(obj){
      try{
        if(obj.status && obj.status.toLowerCase()!=='ok'){
          const e=obj.errors?.[0]?.detailed_message||obj.errors?.[0]?.message||obj.status;
          reject(new Error("GViz error (Asistencia): "+e));
        } else {
          resolve(obj);
        }
      } finally {
        if(old) window.google.visualization.Query.setResponse=old;
      }
    };
    const s=document.createElement("script");
    s.src=url;
    s.async=true;
    s.onerror=()=>{
      if(old) window.google.visualization.Query.setResponse=old;
      reject(new Error("GViz JSONP Asistencia onerror (¬øpermisos?)"));
    };
    document.head.appendChild(s);
    setTimeout(()=>{
      if(window.google.visualization.Query.setResponse===old) return;
      window.google.visualization.Query.setResponse=old;
      reject(new Error("GViz JSONP Asistencia timeout"));
    },8000);
  });
}

/* CSV / PUB para PUNTOS y ASISTENCIA (fallback) */
async function fetchCSV_Puntos(){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_PUNTOS}`;
  const r=await fetch(url,{mode:'cors'});
  if(!r.ok) throw new Error("CSV Puntos HTTP "+r.status);
  return parseCSVtoGVizLike(await r.text());
}
async function fetchPubCSV_Puntos(){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${GID_PUNTOS}&single=true&output=csv`;
  const r=await fetch(url,{mode:'cors'});
  if(!r.ok) throw new Error("PUB CSV Puntos HTTP "+r.status);
  return parseCSVtoGVizLike(await r.text());
}

async function fetchCSV_Asistencia(){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID_ASISTENCIA}`;
  const r=await fetch(url,{mode:'cors'});
  if(!r.ok) throw new Error("CSV Asistencia HTTP "+r.status);
  return parseCSVtoGVizLike(await r.text());
}
async function fetchPubCSV_Asistencia(){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${GID_ASISTENCIA}&single=true&output=csv`;
  const r=await fetch(url,{mode:'cors'});
  if(!r.ok) throw new Error("PUB CSV Asistencia HTTP "+r.status);
  return parseCSVtoGVizLike(await r.text());
}

/* === CARGA PRINCIPAL === */
async function cargar(){
  actualizarCabecera();
  document.getElementById("filtroFecha").value=hoyISO();
  const tbody=document.getElementById("tablaPuntos");
  tbody.innerHTML=`<tr><td colspan="7">Cargando‚Ä¶</td></tr>`;
  setStatus("Cargando datos de puntos y asistencia‚Ä¶");

  try{
    /* === Cargar PUNTOS === */
    let dataPuntos;
    try{
      dataPuntos = await fetchGVizJSONP_Puntos();
      setStatus("Puntos cargados v√≠a GViz (JSONP)...");
    }catch(e1){
      console.warn("GViz JSONP Puntos fall√≥ ‚Üí CSV export", e1);
      try{
        dataPuntos = await fetchCSV_Puntos();
        setStatus("Puntos cargados v√≠a CSV (export)");
      }catch(e2){
        console.warn("CSV export Puntos fall√≥ ‚Üí CSV publicar", e2);
        dataPuntos = await fetchPubCSV_Puntos();
        setStatus("Puntos cargados v√≠a CSV (Publicar en la web)");
      }
    }

    const detP=detectarEstructura(dataPuntos);
    const allRows=dataPuntos.table?.rows||[];
    STATE.rows = (detP.dataStart>0) ? allRows.slice(detP.dataStart) : allRows;
    STATE.idxNombre = detP.idxNombre;
    STATE.dateCols  = detP.dateCols;

    if(!STATE.rows.length){
      setStatus("Sin filas en la hoja de puntos.");
      tbody.innerHTML=`<tr><td colspan="7">Sin filas</td></tr>`;
      return;
    }
    if(!STATE.dateCols.length){
      setStatus("No hay encabezados de fecha v√°lidos en Puntos.");
    }

    /* === Cargar ASISTENCIA === */
    try{
      let dataAsis;
      try{
        dataAsis = await fetchGVizJSONP_Asistencia();
        setStatus("Asistencia cargada v√≠a GViz (JSONP)...");
      }catch(eA1){
        console.warn("GViz JSONP Asistencia fall√≥ ‚Üí CSV export", eA1);
        try{
          dataAsis = await fetchCSV_Asistencia();
          setStatus("Asistencia cargada v√≠a CSV (export)");
        }catch(eA2){
          console.warn("CSV export Asistencia fall√≥ ‚Üí CSV publicar", eA2);
          dataAsis = await fetchPubCSV_Asistencia();
          setStatus("Asistencia cargada v√≠a CSV (Publicar en la web)");
        }
      }
      ASISTENCIA_MAP = buildAsistenciaMap(dataAsis);
      setStatus("Puntos y asistencia cargados correctamente.");
    }catch(eAsis){
      console.warn("No se pudo cargar Asistencia", eAsis);
      ASISTENCIA_MAP = {};
      setStatus("Puntos cargados, pero no se pudo cargar Asistencia (revisa permisos o gid).");
    }

    render();
  }catch(err){
    console.error(err);
    setStatus("Error al cargar (permisos/gid). Comparte como 'Cualquiera con el enlace ‚Üí Lector' o usa 'Publicar en la web'.");
    tbody.innerHTML=`<tr><td colspan="7">Error de carga. Revisa permisos y gid.</td></tr>`;
  }
}

cargar();
</script>
</body>
</html>
